--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")
local Camera = workspace.CurrentCamera

--// Create ScreenGui
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "DevonsArsenalMenu"
ScreenGui.Parent = PlayerGui

--// Main Frame
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 350, 0, 400)
MainFrame.Position = UDim2.new(0.5, -175, 0.5, -200)
MainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

-- Gradient background
local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{ColorSequenceKeypoint.new(0, Color3.fromRGB(50,50,60)), ColorSequenceKeypoint.new(1, Color3.fromRGB(20,20,25))}
gradient.Rotation = 45
gradient.Parent = MainFrame

--// Title Label
local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(1, 0, 0, 50)
TitleLabel.Position = UDim2.new(0, 0, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "Devons Arsenal (v12)"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextSize = 26
TitleLabel.Parent = MainFrame

--// Button creator
local function createButton(name, yPos)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0.8, 0, 0, 40)
    button.Position = UDim2.new(0.1, 0, 0, yPos)
    button.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
    button.BorderSizePixel = 0
    button.Text = name
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.Font = Enum.Font.Gotham
    button.TextSize = 20
    button.Parent = MainFrame
    -- Hover effect
    button.MouseEnter:Connect(function()
        TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(180,0,0)}):Play()
    end)
    button.MouseLeave:Connect(function()
        TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(aimbotEnabled or hitboxEnabled or espEnabled and 0 or 150,0,0)}):Play()
    end)
    return button
end

--// Create buttons
local aimbotButtonY = 70
local AimbotButton = createButton("Aimbot", aimbotButtonY)
local ESPButton = createButton("ESP", aimbotButtonY + 60)
local HitboxExtenderButton = createButton("Hitbox Extender", aimbotButtonY + 120)
local FlyButton = createButton("Fly", aimbotButtonY + 180)
local NoclipButton = createButton("Noclip", aimbotButtonY + 240)

--// Toggle states
local aimbotEnabled = false
local hitboxEnabled = false
local espEnabled = false
local flyEnabled = false
local noclipEnabled = false

--// Toggle helper
local function updateButtonColor(button, state)
    if state then
        button.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
    else
        button.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
    end
end

--// Aimbot Settings
local aimPart = "Head" -- default head
local fov = 100

--// ESP
local ESPBoxes = {}
local ESPColor = Color3.fromRGB(255,0,0)
local hitboxColor = Color3.fromRGB(255,0,0)
local hitboxSize = 5

--// Fly settings
local flySpeed = 50
local flying = false

--// Function to check if player is enemy
local function isEnemy(p)
    return p ~= player and p.Team ~= player.Team
end

--// Create ESP Box
local function createESPBox(p)
    if ESPBoxes[p] then return end
    local box = Drawing.new("Quad")
    box.Color = ESPColor
    box.Thickness = 2
    box.Transparency = 0.5
    ESPBoxes[p] = box
end

local function removeESPBox(p)
    if ESPBoxes[p] then
        ESPBoxes[p]:Remove()
        ESPBoxes[p] = nil
    end
end

--// Update ESP positions
local function updateESP()
    for p, box in pairs(ESPBoxes) do
        if p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = p.Character.HumanoidRootPart
            local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
            if onScreen then
                local size = Vector2.new(100,100)
                local topLeft = Vector2.new(screenPos.X - size.X/2, screenPos.Y - size.Y/2)
                local bottomRight = topLeft + size
                box.PointA = topLeft
                box.PointB = Vector2.new(bottomRight.X, topLeft.Y)
                box.PointC = bottomRight
                box.PointD = Vector2.new(topLeft.X, bottomRight.Y)
                box.Color = ESPColor
                box.Visible = true
            else
                box.Visible = false
            end
        else
            box.Visible = false
        end
    end
end

--// Fly function
local function fly()
    flying = true
    local bodyVel = Instance.new("BodyVelocity")
    bodyVel.MaxForce = Vector3.new(400000,400000,400000)
    bodyVel.Velocity = Vector3.new(0,0,0)
    bodyVel.Parent = player.Character.HumanoidRootPart
    RunService.RenderStepped:Connect(function()
        if flying and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = player.Character.HumanoidRootPart
            local moveDir = Vector3.new()
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + hrp.CFrame.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - hrp.CFrame.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - hrp.CFrame.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + hrp.CFrame.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveDir = moveDir + Vector3.new(0,1,0) end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then moveDir = moveDir - Vector3.new(0,1,0) end
            bodyVel.Velocity = moveDir.Unit * flySpeed
        else
            bodyVel.Velocity = Vector3.new(0,0,0)
        end
    end)
end

--// Noclip function
local function noclip()
    noclipEnabled = not noclipEnabled
    RunService.Stepped:Connect(function()
        if noclipEnabled and player.Character then
            for _, part in pairs(player.Character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end
    end)
end

--// Button Events
AimbotButton.MouseButton1Click:Connect(function()
    aimbotEnabled = not aimbotEnabled
    updateButtonColor(AimbotButton, aimbotEnabled)
end)

ESPButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    updateButtonColor(ESPButton, espEnabled)
    if espEnabled then
        for _, p in pairs(Players:GetPlayers()) do
            if isEnemy(p) then createESPBox(p) end
        end
    else
        for p, _ in pairs(ESPBoxes) do
            removeESPBox(p)
        end
    end
end)

HitboxExtenderButton.MouseButton1Click:Connect(function()
    hitboxEnabled = not hitboxEnabled
    updateButtonColor(HitboxExtenderButton, hitboxEnabled)
end)

FlyButton.MouseButton1Click:Connect(function()
    flyEnabled = not flyEnabled
    updateButtonColor(FlyButton, flyEnabled)
    if flyEnabled then fly() end
end)

NoclipButton.MouseButton1Click:Connect(function()
    noclip()
    updateButtonColor(NoclipButton, noclipEnabled)
end)

--// Main Render Loop
RunService.RenderStepped:Connect(function()
    -- ESP
    if espEnabled then updateESP() end

    -- Hitbox Extender
    if hitboxEnabled then
        for _, p in pairs(Players:GetPlayers()) do
            if isEnemy(p) and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                local hrp = p.Character.HumanoidRootPart
                hrp.Size = Vector3.new(hitboxSize, hitboxSize, hitboxSize)
                hrp.Transparency = 0.5
                hrp.BrickColor = BrickColor.new(hitboxColor)
            end
        end
    end

    -- Aimbot (basic)
    if aimbotEnabled and UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2) then
        local closestPlayer
        local shortestDistance = fov
        local mouse = player:GetMouse()
        for _, p in pairs(Players:GetPlayers()) do
            if isEnemy(p) and p.Character and p.Character:FindFirstChild(aimPart) then
                local pos = Camera:WorldToViewportPoint(p.Character[aimPart].Position)
                local dist = (Vector2.new(pos.X,pos.Y) - Vector2.new(mouse.X,mouse.Y)).Magnitude
                if dist < shortestDistance then
                    shortestDistance = dist
                    closestPlayer = p
                end
            end
        end
        if closestPlayer and closestPlayer.Character and closestPlayer.Character:FindFirstChild(aimPart) then
            local target = closestPlayer.Character[aimPart]
            local cf = CFrame.new(Camera.CFrame.Position, target.Position)
            Camera.CFrame = cf
        end
    end
end)

-- Handle joining players for ESP
Players.PlayerAdded:Connect(function(p)
    if espEnabled and isEnemy(p) then createESPBox(p) end
end)
Players.PlayerRemoving:Connect(function(p)
    removeESPBox(p)
end)
