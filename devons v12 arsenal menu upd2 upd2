--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local player = Players.LocalPlayer

--// Menu State
local MenuState = {
    aimbot = false,
    esp = false,
    hitbox = false,
    killall = false,
    rapidfire = false,
    showFOV = false,
    hitboxSize = 5,
    aimbotFOV = 200,
    rapidFireDelay = 0.1,
    aimbotPart = "Head"
}

--// Helper
local function isEnemy(plr)
    return plr.Team ~= player.Team
end

--// Key GUI
local keyGui = Instance.new("ScreenGui", player.PlayerGui)
keyGui.Name = "KeySystem"

local keyFrame = Instance.new("Frame")
keyFrame.Size = UDim2.new(0,400,0,200)
keyFrame.Position = UDim2.new(0.5,-200,0.5,-100)
keyFrame.BackgroundColor3 = Color3.fromRGB(20,20,20)
keyFrame.BorderSizePixel = 0
keyFrame.Parent = keyGui

local UICornerKF = Instance.new("UICorner")
UICornerKF.CornerRadius = UDim.new(0,12)
UICornerKF.Parent = keyFrame

local keyLabel = Instance.new("TextLabel")
keyLabel.Size = UDim2.new(1,0,0,50)
keyLabel.Position = UDim2.new(0,0,0,10)
keyLabel.Text = "Enter Key to Access Menu"
keyLabel.TextColor3 = Color3.fromRGB(255,165,0)
keyLabel.Font = Enum.Font.GothamBold
keyLabel.TextSize = 24
keyLabel.BackgroundTransparency = 1
keyLabel.Parent = keyFrame

local keyBox = Instance.new("TextBox")
keyBox.Size = UDim2.new(0.8,0,0,40)
keyBox.Position = UDim2.new(0.1,0,0,80)
keyBox.PlaceholderText = "Enter Key Here"
keyBox.Text = ""
keyBox.TextColor3 = Color3.fromRGB(255,255,255)
keyBox.BackgroundColor3 = Color3.fromRGB(40,40,40)
keyBox.Font = Enum.Font.Gotham
keyBox.TextSize = 20
keyBox.ClearTextOnFocus = true
keyBox.Parent = keyFrame

local enterButton = Instance.new("TextButton")
enterButton.Size = UDim2.new(0.5,0,0,40)
enterButton.Position = UDim2.new(0.25,0,0,140)
enterButton.Text = "Enter"
enterButton.TextColor3 = Color3.fromRGB(255,255,255)
enterButton.BackgroundColor3 = Color3.fromRGB(150,0,0)
enterButton.Font = Enum.Font.GothamBold
enterButton.TextSize = 22
enterButton.Parent = keyFrame

--// Load Menu
local function loadMenu()
    keyGui:Destroy()

    local ScreenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
    ScreenGui.Name = "DevonsArsenalMenu"

    local MainFrame = Instance.new("Frame")
    MainFrame.Size = UDim2.new(0,460,0,650)
    MainFrame.Position = UDim2.new(0.5,-230,0.5,-325)
    MainFrame.BackgroundColor3 = Color3.fromRGB(20,20,20)
    MainFrame.BorderSizePixel = 0
    MainFrame.Active = true
    MainFrame.Parent = ScreenGui

    local UICornerMain = Instance.new("UICorner")
    UICornerMain.CornerRadius = UDim.new(0, 12)
    UICornerMain.Parent = MainFrame

    -- Header
    local Header = Instance.new("Frame")
    Header.Size = UDim2.new(1,0,0,60)
    Header.Position = UDim2.new(0,0,0,0)
    Header.BackgroundColor3 = Color3.fromRGB(255,140,0)
    Header.BorderSizePixel = 0
    Header.Parent = MainFrame

    local HeaderTitle = Instance.new("TextLabel")
    HeaderTitle.Size = UDim2.new(1,0,1,0)
    HeaderTitle.Position = UDim2.new(0,0,0,0)
    HeaderTitle.BackgroundTransparency = 1
    HeaderTitle.Text = "Devons Arsenal Menu (v17)"
    HeaderTitle.TextColor3 = Color3.fromRGB(255,165,0)
    HeaderTitle.Font = Enum.Font.GothamBold
    HeaderTitle.TextSize = 26
    HeaderTitle.Parent = Header

    local HeaderImage = Instance.new("ImageLabel")
    HeaderImage.Size = UDim2.new(0,40,0,40)
    HeaderImage.Position = UDim2.new(1,-50,0,10)
    HeaderImage.BackgroundTransparency = 1
    HeaderImage.Image = "rbxassetid://101270819539963"
    HeaderImage.Parent = Header

    -- Buttons
    local function createButton(name, yPos, stateKey)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0.8,0,0,45)
        btn.Position = UDim2.new(0.1,0,0,yPos)
        btn.BackgroundColor3 = MenuState[stateKey] and Color3.fromRGB(255,0,0) or Color3.fromRGB(150,0,0)
        btn.BorderSizePixel = 0
        btn.Text = name
        btn.TextColor3 = Color3.fromRGB(255,255,255)
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 20
        btn.Parent = MainFrame

        local UICornerBtn = Instance.new("UICorner")
        UICornerBtn.CornerRadius = UDim.new(0, 8)
        UICornerBtn.Parent = btn

        btn.MouseButton1Click:Connect(function()
            MenuState[stateKey] = not MenuState[stateKey]
            btn.BackgroundColor3 = MenuState[stateKey] and Color3.fromRGB(255,0,0) or Color3.fromRGB(150,0,0)
        end)
        return btn
    end

    createButton("Aimbot", 80, "aimbot")
    createButton("ESP", 150, "esp")
    createButton("Hitbox Extender", 220, "hitbox")
    createButton("Kill All", 290, "killall")
    createButton("Rapid Fire", 360, "rapidfire")
    createButton("Show FOV", 430, "showFOV")

    -- Head/Torso toggle
    local PartToggle = Instance.new("TextButton")
    PartToggle.Size = UDim2.new(0,60,0,30)
    PartToggle.Position = UDim2.new(0.65,0,80/650,5)
    PartToggle.BackgroundColor3 = Color3.fromRGB(255,140,0)
    PartToggle.BorderSizePixel = 0
    PartToggle.Text = MenuState.aimbotPart
    PartToggle.TextColor3 = Color3.fromRGB(255,255,255)
    PartToggle.Font = Enum.Font.Gotham
    PartToggle.TextSize = 14
    PartToggle.Parent = MainFrame

    PartToggle.MouseButton1Click:Connect(function()
        MenuState.aimbotPart = (MenuState.aimbotPart == "Head") and "Torso" or "Head"
        PartToggle.Text = MenuState.aimbotPart
    end)

    -- Sliders
    local function createSlider(name, yPos, min, max, valueKey)
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(0.8,0,0,30)
        frame.Position = UDim2.new(0.1,0,0,yPos)
        frame.BackgroundColor3 = Color3.fromRGB(255,140,0)
        frame.Parent = MainFrame

        local UICornerFrame = Instance.new("UICorner")
        UICornerFrame.CornerRadius = UDim.new(0,6)
        UICornerFrame.Parent = frame

        local textLabel = Instance.new("TextLabel")
        textLabel.Size = UDim2.new(1,0,0.5,0)
        textLabel.BackgroundTransparency = 1
        textLabel.Position = UDim2.new(0,0,0,0)
        textLabel.Text = name .. ": " .. MenuState[valueKey]
        textLabel.TextColor3 = Color3.fromRGB(255,165,0)
        textLabel.Font = Enum.Font.Gotham
        textLabel.TextSize = 14
        textLabel.Parent = frame

        local slider = Instance.new("Frame")
        slider.Size = UDim2.new(0, 200,0,8)
        slider.Position = UDim2.new(0,0,0.7,0)
        slider.BackgroundColor3 = Color3.fromRGB(150,0,0)
        slider.Parent = frame

        local handle = Instance.new("TextButton")
        handle.Size = UDim2.new(0,12,0,20)
        handle.Position = UDim2.new((MenuState[valueKey]-min)/(max-min),0,0,-6)
        handle.BackgroundColor3 = Color3.fromRGB(255,0,0)
        handle.Text = ""
        handle.Parent = slider

        local dragging = false
        handle.MouseButton1Down:Connect(function()
            dragging = true
        end)
        UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        RunService.RenderStepped:Connect(function()
            if dragging then
                local mouseX = UserInputService:GetMouseLocation().X
                local sliderPos = slider.AbsolutePosition.X
                local sliderSize = slider.AbsoluteSize.X
                local ratio = math.clamp((mouseX - sliderPos)/sliderSize,0,1)
                local val = min + (max-min)*ratio
                MenuState[valueKey] = val
                handle.Position = UDim2.new(ratio,0,0,-6)
                textLabel.Text = name .. ": " .. math.floor(val*100)/100
            end
        end)
    end

    createSlider("Aimbot FOV", 500, 50, 600, "aimbotFOV")
    createSlider("Hitbox Size", 540, 5, 30, "hitboxSize")
    createSlider("Rapid Fire Delay", 580, 0.01, 0.5, "rapidFireDelay")

    -- Draggable Header
    local dragging = false
    local dragInput, mousePos, framePos
    Header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            mousePos = input.Position
            framePos = MainFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    Header.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    RunService.RenderStepped:Connect(function()
        if dragging and dragInput then
            local delta = dragInput.Position - mousePos
            MainFrame.Position = framePos + UDim2.new(0, delta.X, 0, delta.Y)
        end
    end)

    -- Cheats
    local rapidFireLast = 0
    local fovCircle
    RunService.RenderStepped:Connect(function()
        -- FOV Circle
        if MenuState.showFOV then
            if not fovCircle then
                fovCircle = Drawing.new("Circle")
                fovCircle.Color = Color3.fromRGB(255,165,0)
                fovCircle.Thickness = 2
                fovCircle.NumSides = 100
                fovCircle.Filled = false
                fovCircle.Visible = true
            end
            local mousePos = UserInputService:GetMouseLocation()
            fovCircle.Position = Vector2.new(mousePos.X,mousePos.Y)
            fovCircle.Radius = MenuState.aimbotFOV
        elseif fovCircle then
            fovCircle:Remove()
            fovCircle = nil
        end

        -- Aimbot
        if MenuState.aimbot and UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2) then
            local closest
            local shortest = math.huge
            local mouse = player:GetMouse()
            for _,plr in pairs(Players:GetPlayers()) do
                if plr ~= player and isEnemy(plr) and plr.Character then
                    local targetPart = plr.Character:FindFirstChild(MenuState.aimbotPart)
                    if targetPart then
                        local offset = (MenuState.aimbotPart=="Head") and Vector3.new(0,0.5,0) or Vector3.new(0,1,0)
                        local screenPos, onScreen = Camera:WorldToViewportPoint(targetPart.Position + offset)
                        if onScreen then
                            local dist = (Vector2.new(screenPos.X,screenPos.Y)-Vector2.new(mouse.X,mouse.Y)).Magnitude
                            if dist < shortest and dist < MenuState.aimbotFOV then
                                shortest = dist
                                closest = plr
                            end
                        end
                    end
                end
            end
            if closest and closest.Character then
                local targetPart = closest.Character:FindFirstChild(MenuState.aimbotPart)
                if targetPart then
                    local offset = (MenuState.aimbotPart=="Head") and Vector3.new(0,0.5,0) or Vector3.new(0,1,0)
                    local delta = Camera:WorldToViewportPoint(targetPart.Position+offset) - Vector3.new(player:GetMouse().X,player:GetMouse().Y,0)
                    pcall(function() mousemoverel(delta.X*0.5, delta.Y*0.5) end)
                end
            end
        end

        -- Rapid Fire
        if MenuState.rapidfire and tick()-rapidFireLast >= MenuState.rapidFireDelay then
            rapidFireLast = tick()
            local tool = player.Character and player.Character:FindFirstChildOfClass("Tool")
            if tool then tool:Activate() end
        end

        -- Kill All
        if MenuState.killall then
            for _,plr in pairs(Players:GetPlayers()) do
                if plr ~= player and isEnemy(plr) and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                    local hrp = plr.Character.HumanoidRootPart
                    player.Character.HumanoidRootPart.CFrame = hrp.CFrame * CFrame.new(0,0,3)
                    local tool = player.Character and player.Character:FindFirstChildOfClass("Tool")
                    if tool then tool:Activate() end
                end
            end
        end

        -- Hitbox Extender
        if MenuState.hitbox then
            for _,plr in pairs(Players:GetPlayers()) do
                if plr ~= player and isEnemy(plr) and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                    local hrp = plr.Character.HumanoidRootPart
                    hrp.Size = Vector3.new(MenuState.hitboxSize,MenuState.hitboxSize,MenuState.hitboxSize)
                    hrp.Transparency = 0.5
                end
            end
        end

        -- ESP
        if MenuState.esp then
            for _,plr in pairs(Players:GetPlayers()) do
                if plr ~= player and isEnemy(plr) and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                    local hrp = plr.Character.HumanoidRootPart
                    if not hrp:FindFirstChild("ESP") then
                        local bill = Instance.new("BillboardGui")
                        bill.Name = "ESP"
                        bill.Adornee = hrp
                        bill.Size = UDim2.new(0,100,0,40)
                        bill.StudsOffset = Vector3.new(0,3,0)
                        bill.AlwaysOnTop = true
                        bill.Parent = hrp

                        local frame = Instance.new("Frame")
                        frame.Size = UDim2.new(1,0,1,0)
                        frame.BackgroundTransparency = 0.5
                        frame.BackgroundColor3 = Color3.fromRGB(255,140,0)
                        frame.BorderSizePixel = 0
                        frame.Parent = bill

                        local nameLabel = Instance.new("TextLabel")
                        nameLabel.Size = UDim2.new(1,0,1,0)
                        nameLabel.BackgroundTransparency = 1
                        nameLabel.Text = plr.Name
                        nameLabel.TextColor3 = Color3.fromRGB(0,0,0)
                        nameLabel.TextScaled = true
                        nameLabel.Font = Enum.Font.GothamBold
                        nameLabel.Parent = frame
                    end
                else
                    if plr.Character then
                        local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
                        if hrp and hrp:FindFirstChild("ESP") then
                            hrp.ESP:Destroy()
                        end
                    end
                end
            end
        end
    end)
end

--// Key Button
enterButton.MouseButton1Click:Connect(function()
    local validKeys = {
        ["DEVON2025"]=true,
        [""]=true
    }
    if validKeys[keyBox.Text] then
        loadMenu()
    else
        keyLabel.Text = "Invalid Key!"
        keyLabel.TextColor3 = Color3.fromRGB(255,0,0)
    end
end)
